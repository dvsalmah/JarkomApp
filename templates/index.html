<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarkom Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>

<body class="bg-gray-100 h-screen flex items-center justify-center">
    
    <div class="w-full max-w-md bg-white h-[85vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-200">
        
        <div class="bg-rose-600 p-4 text-white shadow-md z-10 shrink-0">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z"/>
                        </svg>
                        <span class="font-bold text-lg">{{ username }}</span>
                    </div>
                    <p class="text-xs text-rose-100 opacity-90 mt-1">IP: {{ ip }} â€¢ Port: {{ port }}</p>
                </div>
                <div class="h-3 w-3 bg-green-500 rounded-full animate-pulse" title="Online"></div>
            </div>
        </div>

        <div id="chat-display" class="flex-1 bg-slate-50 p-4 overflow-y-auto space-y-3 flex flex-col">
            <div class="text-center text-xs text-gray-400 my-4">
                <span class="bg-gray-200 px-3 py-1 rounded-full">Mulai percakapan aman P2P</span>
            </div>
        </div>

        <div class="bg-white p-3 border-t border-gray-100 shrink-0">
            <div class="mb-2">
                <input type="text" id="targetUser" 
                    class="w-full bg-gray-100 text-sm px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500 transition" 
                    placeholder="Chat siapa? (cth: budi)">
            </div>
            
            <div class="flex gap-2">
                <input type="text" id="messageInput" 
                    class="flex-1 bg-gray-100 px-4 py-3 rounded-full focus:outline-none focus:ring-2 focus:ring-rose-500 transition" 
                    placeholder="Ketik pesan...">
                
                <button onclick="sendMessage()" 
                    class="bg-rose-600 hover:bg-rose-700 text-white h-12 w-12 rounded-full flex items-center justify-center shadow-lg transition active:scale-90">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform rotate-90" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </div>

    </div> <script>
        const chatBox = document.getElementById('chat-display');

        setInterval(() => {
            fetch('/get_chats')
            .then(response => response.json())
            .then(data => {
                // Simpan posisi scroll sebelum update
                const isScrolledToBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 100;

                chatBox.innerHTML = '<div class="text-center text-xs text-gray-400 my-4"><span class="bg-gray-200 px-3 py-1 rounded-full">Mulai percakapan aman P2P</span></div>';
                
                data.forEach(chat => {
                    const div = document.createElement('div');
                    if (chat.type === 'out') {
                        div.className = "self-end bg-rose-600 text-white max-w-[80%] px-4 py-2 rounded-2xl rounded-tr-none shadow-sm text-sm";
                        div.innerHTML = `<b>Anda:</b> ${chat.msg.split(': ')[1] || chat.msg}`;
                    } else {
                        div.className = "self-start bg-white text-gray-800 max-w-[80%] px-4 py-2 rounded-2xl rounded-tl-none shadow-sm border border-gray-200 text-sm";
                        div.innerHTML = `<b class="text-rose-600 text-xs block mb-1">${chat.sender}</b> ${chat.msg}`;
                    }
                    chatBox.appendChild(div);
                });
                
                if(isScrolledToBottom) {
                   chatBox.scrollTop = chatBox.scrollHeight;
                }
            });
        }, 1000);

        document.getElementById("messageInput").addEventListener("keyup", function(event) {
            if (event.key === "Enter") { sendMessage(); }
        });

        function sendMessage() {
            const target = document.getElementById('targetUser').value;
            const msg = document.getElementById('messageInput').value;

            if(!target || !msg) return; 

            fetch('/send_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target: target, message: msg })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    document.getElementById('messageInput').value = '';
                } else {
                    alert("Gagal: " + data.msg);
                }
            });
        }
    </script>
</body>
</html>